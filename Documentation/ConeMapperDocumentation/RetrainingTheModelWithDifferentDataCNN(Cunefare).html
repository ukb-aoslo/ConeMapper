<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge,IE=9,chrome=1"><meta name="generator" content="MATLAB 2022b"><title>Retraining the model with different data  CNN (Cunefare)</title><style type="text/css">.rtcContent { padding: 30px; } .S0 { margin: 3px 10px 5px 4px; padding: 0px; line-height: 28.8px; min-height: 0px; white-space: pre-wrap; color: rgb(192, 76, 11); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 24px; font-weight: 400; text-align: left;  }
.S1 { margin: 20px 10px 5px 4px; padding: 0px; line-height: 20px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 20px; font-weight: 700; text-align: left;  }
.S2 { margin: 2px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: left;  }
.CodeBlock { background-color: #F5F5F5; margin: 10px 0 10px 0; }
.S3 { border-left: 1px solid rgb(191, 191, 191); border-right: 1px solid rgb(191, 191, 191); border-top: 1px solid rgb(191, 191, 191); border-bottom: 0px none rgb(33, 33, 33); border-radius: 4px 4px 0px 0px; padding: 6px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S4 { border-left: 1px solid rgb(191, 191, 191); border-right: 1px solid rgb(191, 191, 191); border-top: 0px none rgb(33, 33, 33); border-bottom: 0px none rgb(33, 33, 33); border-radius: 0px; padding: 0px 45px 0px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S5 { border-left: 1px solid rgb(191, 191, 191); border-right: 1px solid rgb(191, 191, 191); border-top: 0px none rgb(33, 33, 33); border-bottom: 1px solid rgb(191, 191, 191); border-radius: 0px 0px 4px 4px; padding: 0px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S6 { margin: 10px 0px 20px; padding-left: 0px; font-family: Helvetica, Arial, sans-serif; font-size: 14px;  }
.S7 { margin-left: 56px; line-height: 21px; min-height: 0px; text-align: left; white-space: pre-wrap;  }
.S8 { border-left: 1px solid rgb(191, 191, 191); border-right: 1px solid rgb(191, 191, 191); border-top: 1px solid rgb(191, 191, 191); border-bottom: 1px solid rgb(191, 191, 191); border-radius: 4px; padding: 6px 45px 4px 13px; line-height: 18.004px; min-height: 0px; white-space: nowrap; color: rgb(33, 33, 33); font-family: Menlo, Monaco, Consolas, "Courier New", monospace; font-size: 14px;  }
.S9 { margin: 10px 10px 9px 4px; padding: 0px; line-height: 21px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 14px; font-weight: 400; text-align: left;  }
.S10 { margin: 15px 10px 5px 4px; padding: 0px; line-height: 18px; min-height: 0px; white-space: pre-wrap; color: rgb(33, 33, 33); font-family: Helvetica, Arial, sans-serif; font-style: normal; font-size: 17px; font-weight: 700; text-align: left;  }</style></head><body><div class = rtcContent><h1  class = 'S0'><span>Retraining the model with different data  CNN (Cunefare)</span></h1><h2  class = 'S1'><span style=' font-weight: bold; font-family: monospace;'>Introduction</span></h2><div  class = 'S2'><span>It is possible to train CNN (Cunefare) on another dataset. It may improve the results for your type of images.</span></div><h2  class = 'S1'><span>Folder and data structure</span></h2><div  class = 'S2'><span>In order to do so, you need to have your data as image tiles 144*144px size in .tiff format and corresponding files with coordinates of the cones (txt or csv).</span></div><div  class = 'S2'><span>The prefered structure of the data files:</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >{ConeMapperFolder}/Images and </span><span style="color: rgb(167, 9, 245);">Results/{Name of your dataset}</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                            |-Training Images</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                                |-image1.tiff</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                                |-image2.tiff</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                                    </span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                            |-Training Manual </span><span style="color: rgb(167, 9, 245);">Coord</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                                |-image1.csv</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                                |-image2.csv</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                                    </span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                            |-Validation Images</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                                |-image3.tiff</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                                |-image4.tiff</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                                    </span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                            |-Validation Manual </span><span style="color: rgb(167, 9, 245);">Coord</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                                |-image3.csv</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                                                |-image4.csv</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre"><span >                                                    </span><span style="color: rgb(14, 0, 255);">...</span></span></div></div></div><h2  class = 'S1'><span>Data preparation</span></h2><div  class = 'S2'><span>You need to prepare data by yourself:</span></div><ul  class = 'S6'><li  class = 'S7'><span>split into training and validation sets</span></li><li  class = 'S7'><span>cut in tiles 144*144px by prefered method</span></li><li  class = 'S7'><span>export into .tiff +.csv/.txt format</span></li><li  class = 'S7'><span>put in proper folders</span></li></ul><h2  class = 'S1'><span>Training</span></h2><div  class = 'S2'><span>Before training, you need to add DataSet description (analog to others descriptions) into </span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span >{ConeMapperFolder}/CNN_Code/get_parameters_Cone_CNN.m</span></span></div></div></div><div  class = 'S9'><span>For example:</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span style="color: rgb(14, 0, 255);">case </span><span style="color: rgb(167, 9, 245);">'NEW_SET_NAME' </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">%%%% General parameters</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% location of images and coordinate files</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.ImageDirTrain = fullfile(BasePath,</span><span style="color: rgb(167, 9, 245);">'Images and Results'</span><span >,</span><span style="color: rgb(167, 9, 245);">'NEW_SET_NAME'</span><span >,</span><span style="color: rgb(167, 9, 245);">'Training Images'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.ManualCoordDirTrain = fullfile(BasePath,</span><span style="color: rgb(167, 9, 245);">'Images and Results'</span><span >,</span><span style="color: rgb(167, 9, 245);">'NEW_SET_NAME'</span><span >,</span><span style="color: rgb(167, 9, 245);">'Training Manual Coord'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.ImageDirValidate = fullfile(BasePath,</span><span style="color: rgb(167, 9, 245);">'Images and Results'</span><span >,</span><span style="color: rgb(167, 9, 245);">'NEW_SET_NAME'</span><span >,</span><span style="color: rgb(167, 9, 245);">'Validation Images'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.ManualCoordDirValidate = fullfile(BasePath,</span><span style="color: rgb(167, 9, 245);">'Images and Results'</span><span >,</span><span style="color: rgb(167, 9, 245);">'NEW_SET_NAME'</span><span >,</span><span style="color: rgb(167, 9, 245);">'Validation Manual Coord'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% Extension on Images</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.ImageExt =</span><span style="color: rgb(167, 9, 245);">'.tif'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% Text to add on to base of image names for coord files</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.CoordAdditionalText = </span><span style="color: rgb(167, 9, 245);">''</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% Format of coord file</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.CoordExt = </span><span style="color: rgb(167, 9, 245);">'.csv'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">%%%%% Parameters for imdb </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% Set path to save imdb</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        SaveName = </span><span style="color: rgb(167, 9, 245);">'imdb-NEW_SET_NAME-ConeCNN.mat'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.imdb.SavePath = fullfile(BasePath,</span><span style="color: rgb(167, 9, 245);">'Images and Results'</span><span >,</span><span style="color: rgb(167, 9, 245);">'NEW_SET_NAME'</span><span >,SaveName);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">%%%%% CNN training parameters</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% Set path to load imdb</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.CNN.imdbPath =  params.imdb.SavePath;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% Set path to save network training steps</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        SaveNameNetTrain = </span><span style="color: rgb(167, 9, 245);">'CNN Training-NEW_SET_NAME'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.CNN.TrainExpDir = fullfile(BasePath,</span><span style="color: rgb(167, 9, 245);">'Images and Results'</span><span >,</span><span style="color: rgb(167, 9, 245);">'NEW_SET_NAME'</span><span >,SaveNameNetTrain);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% Set path to save final network</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        SaveNameFinalNet = </span><span style="color: rgb(167, 9, 245);">'net-epoch-45-NEW_SET_NAME-ConeCNN.mat'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.CNN.NetworkSavePath = fullfile(BasePath,</span><span style="color: rgb(167, 9, 245);">'Images and Results'</span><span >,</span><span style="color: rgb(167, 9, 245);">'NEW_SET_NAME'</span><span >,SaveNameFinalNet);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">%%%% Proabability map parameters</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% Set path to load network</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.ProbMap.NetworkPath =  params.CNN.NetworkSavePath;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% Set paths to save probability maps</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.ProbMap.SaveDirTrain  = fullfile(BasePath,</span><span style="color: rgb(167, 9, 245);">'Images and Results'</span><span >,</span><span style="color: rgb(167, 9, 245);">'NEW_SET_NAME'</span><span >,</span><span style="color: rgb(167, 9, 245);">'Probability Maps'</span><span >,</span><span style="color: rgb(167, 9, 245);">'Training'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.ProbMap.SaveDirValidate  = fullfile(BasePath,</span><span style="color: rgb(167, 9, 245);">'Images and Results'</span><span >,</span><span style="color: rgb(167, 9, 245);">'NEW_SET_NAME'</span><span >,</span><span style="color: rgb(167, 9, 245);">'Probability Maps'</span><span >,</span><span style="color: rgb(167, 9, 245);">'Validation'</span><span >);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">%%%% Optimization parameters</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% Set path to load training probability maps</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.Opt.ProbMapDirTrain = params.ProbMap.SaveDirTrain;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% Set path to save the optimization results</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        SaveNameOpt = </span><span style="color: rgb(167, 9, 245);">'DetectionOptimization-NEW_SET_NAME-ConeCNN.mat'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.Opt.SavePath = fullfile(BasePath,</span><span style="color: rgb(167, 9, 245);">'Images and Results'</span><span >,</span><span style="color: rgb(167, 9, 245);">'NEW_SET_NAME'</span><span >,SaveNameOpt);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">%%%%% Validation result parameters</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% Set path for loading optimization results</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.Results.OptimizationPath = params.Opt.SavePath;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% Set path for saving detected cones from validation set</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        SaveNameVal = </span><span style="color: rgb(167, 9, 245);">'Validation CNN Coord'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        params.Results.SaveDir = fullfile(BasePath,</span><span style="color: rgb(167, 9, 245);">'Images and Results'</span><span >,</span><span style="color: rgb(167, 9, 245);">'NEW_SET_NAME'</span><span >,SaveNameVal);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >        </span><span style="color: rgb(0, 128, 19);">% Set path to load validation probability maps</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre"><span >        params.Results.ProbMapDirValidate = params.ProbMap.SaveDirValidate;</span></span></div></div></div><div  class = 'S9'><span>Then in script</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span >{ConeMapperFolder}/CNN_Code/RunCNNConeDetection.m</span></span></div></div></div><div  class = 'S9'><span>you need to setup the name of the new data set (line 39)</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S8'><span style="white-space: pre"><span >DataSet = </span><span style="color: rgb(167, 9, 245);">'NEW_SET_NAME'</span><span >;</span></span></div></div></div><h2  class = 'S1'><span>Including the retrained model into Cone Mapper</span></h2><div  class = 'S2'><span>After training is finished you must add the new choice into Cone Mapper CNN Menu (function CnnFinder, line 2128).</span></div><div class="CodeBlock"><div class="inlineWrapper"><div  class = 'S3'><span style="white-space: pre"><span >fn = {</span><span style="color: rgb(167, 9, 245);">'g1+cunefare'</span><span >, </span><span style="color: rgb(167, 9, 245);">'alex training set'</span><span >, </span><span style="color: rgb(167, 9, 245);">'41 eye jlr set (black cut)'</span><span >, </span><span style="color: rgb(167, 9, 245);">'julius montages'</span><span >, </span><span style="color: rgb(167, 9, 245);">'julius montages2'</span><span >, </span><span style="color: rgb(167, 9, 245);">'49 montages (2024)'</span><span >, </span><span style="color: rgb(167, 9, 245);">'NEW_SET_USER_FRIENDLY_NAME'</span><span >};</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >            [indx, tf] = listdlg(</span><span style="color: rgb(167, 9, 245);">'Name'</span><span >, </span><span style="color: rgb(167, 9, 245);">'Cone Finder Data Sets'</span><span >, </span><span style="color: rgb(167, 9, 245);">'PromptString'</span><span >, {</span><span style="color: rgb(167, 9, 245);">'Select a cone finder data set.'</span><span >},</span><span style="color: rgb(14, 0, 255);">...</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                </span><span style="color: rgb(167, 9, 245);">'SelectionMode'</span><span >,</span><span style="color: rgb(167, 9, 245);">'single'</span><span >,</span><span style="color: rgb(167, 9, 245);">'ListString'</span><span >, fn);</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >            </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >            </span><span style="color: rgb(0, 128, 19);">% if user clicked 'Cancel'</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >            </span><span style="color: rgb(14, 0, 255);">if </span><span >~tf</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                DataSet = </span><span style="color: rgb(167, 9, 245);">'hamwoodset'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >            </span><span style="color: rgb(14, 0, 255);">else</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                </span><span style="color: rgb(14, 0, 255);">switch </span><span >indx</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                    </span><span style="color: rgb(14, 0, 255);">case </span><span >1 </span><span style="color: rgb(0, 128, 19);">% 'g1+cunefare'</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                        DataSet = </span><span style="color: rgb(167, 9, 245);">'g1+cunefare'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                    </span><span style="color: rgb(14, 0, 255);">case </span><span >2 </span><span style="color: rgb(0, 128, 19);">% 'alex training set'</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                        DataSet = </span><span style="color: rgb(167, 9, 245);">'alex training set'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                       </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                    </span><span style="color: rgb(14, 0, 255);">case </span><span >3</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                        DataSet = </span><span style="color: rgb(167, 9, 245);">'41 eye jlr set (black cut)'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                        </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                    </span><span style="color: rgb(14, 0, 255);">case </span><span >4</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                        DataSet = </span><span style="color: rgb(167, 9, 245);">'julius montages'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                    </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                    </span><span style="color: rgb(14, 0, 255);">case </span><span >5</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                        DataSet = </span><span style="color: rgb(167, 9, 245);">'julius montages2'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                    </span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                    </span><span style="color: rgb(14, 0, 255);">case </span><span >6</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                        DataSet = </span><span style="color: rgb(167, 9, 245);">'hamwoodset'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'>&nbsp;</div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                    </span><span style="color: rgb(14, 0, 255);">case </span><span >7</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                        DataSet = </span><span style="color: rgb(167, 9, 245);">'NEW_SET_NAME'</span><span >;</span></span></div></div><div class="inlineWrapper"><div  class = 'S4'><span style="white-space: pre"><span >                </span><span style="color: rgb(14, 0, 255);">end </span><span style="color: rgb(0, 128, 19);">% switch</span></span></div></div><div class="inlineWrapper"><div  class = 'S5'><span style="white-space: pre"><span >            </span><span style="color: rgb(14, 0, 255);">end</span></span></div></div></div><div  class = 'S9'><span>Don't forget that order in 'fn' cell array is corresponding to the numbers in switch statement.</span></div><h3  class = 'S10'><span>See also</span></h3><div  class = 'S2'><span>For more information about Cunefare CNN, please check the github page: </span><a href = "https://github.com/DavidCunefare/CNN-Cone-Detection"><span>https://github.com/DavidCunefare/CNN-Cone-Detection</span></a></div><div  class = 'S2'><span>And check his article: Cunefare, D., Fang, L., Cooper, R.F. </span><span style=' font-style: italic;'>et al.</span><span> Open source software for automatic detection of cone photoreceptors in adaptive optics ophthalmoscopy using convolutional neural networks. </span><span style=' font-style: italic;'>Sci Rep</span><span> </span><span style=' font-weight: bold;'>7</span><span>, 6620 (2017). </span><a href = "https://doi.org/10.1038/s41598-017-07103-0"><span>https://doi.org/10.1038/s41598-017-07103-0</span></a></div>
<br>
<!-- 
##### SOURCE BEGIN #####
%% Retraining the model with different data  CNN (Cunefare)
%% |*Introduction*|
% It is possible to train CNN (Cunefare) on another dataset. It may improve 
% the results for your type of images.
%% Folder and data structure
% In order to do so, you need to have your data as image tiles 144*144px size 
% in .tiff format and corresponding files with coordinates of the cones (txt or 
% csv).
% 
% The prefered structure of the data files:

{ConeMapperFolder}/Images and Results/{Name of your dataset}
                                            |-Training Images
                                                |-image1.tiff
                                                |-image2.tiff
                                                    ...
                                            |-Training Manual Coord
                                                |-image1.csv
                                                |-image2.csv
                                                    ...
                                            |-Validation Images
                                                |-image3.tiff
                                                |-image4.tiff
                                                    ...
                                            |-Validation Manual Coord
                                                |-image3.csv
                                                |-image4.csv
                                                    ...
%% Data preparation
% You need to prepare data by yourself:
%% 
% * split into training and validation sets
% * cut in tiles 144*144px by prefered method
% * export into .tiff +.csv/.txt format
% * put in proper folders
%% Training
% Before training, you need to add DataSet description (analog to others descriptions) 
% into 

{ConeMapperFolder}/CNN_Code/get_parameters_Cone_CNN.m
%% 
% For example:

case 'NEW_SET_NAME' 
        %%%% General parameters
        % location of images and coordinate files
        params.ImageDirTrain = fullfile(BasePath,'Images and Results','NEW_SET_NAME','Training Images');
        params.ManualCoordDirTrain = fullfile(BasePath,'Images and Results','NEW_SET_NAME','Training Manual Coord');
        
        params.ImageDirValidate = fullfile(BasePath,'Images and Results','NEW_SET_NAME','Validation Images');
        params.ManualCoordDirValidate = fullfile(BasePath,'Images and Results','NEW_SET_NAME','Validation Manual Coord');
        
        % Extension on Images
        params.ImageExt ='.tif';
        
        % Text to add on to base of image names for coord files
        params.CoordAdditionalText = '';
        
        % Format of coord file
        params.CoordExt = '.csv';
        
                
        %%%%% Parameters for imdb 
        % Set path to save imdb
        SaveName = 'imdb-NEW_SET_NAME-ConeCNN.mat';
        params.imdb.SavePath = fullfile(BasePath,'Images and Results','NEW_SET_NAME',SaveName);
        
        
        %%%%% CNN training parameters
        % Set path to load imdb
        params.CNN.imdbPath =  params.imdb.SavePath;
        
        % Set path to save network training steps
        SaveNameNetTrain = 'CNN Training-NEW_SET_NAME';
        params.CNN.TrainExpDir = fullfile(BasePath,'Images and Results','NEW_SET_NAME',SaveNameNetTrain);
        
        % Set path to save final network
        SaveNameFinalNet = 'net-epoch-45-NEW_SET_NAME-ConeCNN.mat';
        params.CNN.NetworkSavePath = fullfile(BasePath,'Images and Results','NEW_SET_NAME',SaveNameFinalNet);
        
        
        %%%% Proabability map parameters
        % Set path to load network
        params.ProbMap.NetworkPath =  params.CNN.NetworkSavePath;
        
        % Set paths to save probability maps
        params.ProbMap.SaveDirTrain  = fullfile(BasePath,'Images and Results','NEW_SET_NAME','Probability Maps','Training');
        params.ProbMap.SaveDirValidate  = fullfile(BasePath,'Images and Results','NEW_SET_NAME','Probability Maps','Validation');
        
        
        %%%% Optimization parameters
        % Set path to load training probability maps
        params.Opt.ProbMapDirTrain = params.ProbMap.SaveDirTrain;
        
        % Set path to save the optimization results
        SaveNameOpt = 'DetectionOptimization-NEW_SET_NAME-ConeCNN.mat';
        params.Opt.SavePath = fullfile(BasePath,'Images and Results','NEW_SET_NAME',SaveNameOpt);
        
        
        %%%%% Validation result parameters
        % Set path for loading optimization results
        params.Results.OptimizationPath = params.Opt.SavePath;
        
        % Set path for saving detected cones from validation set
        SaveNameVal = 'Validation CNN Coord';
        params.Results.SaveDir = fullfile(BasePath,'Images and Results','NEW_SET_NAME',SaveNameVal);
        
        % Set path to load validation probability maps
        params.Results.ProbMapDirValidate = params.ProbMap.SaveDirValidate;
%% 
% Then in script

{ConeMapperFolder}/CNN_Code/RunCNNConeDetection.m
%% 
% you need to setup the name of the new data set (line 39)

DataSet = 'NEW_SET_NAME';
%% Including the retrained model into Cone Mapper
% After training is finished you must add the new choice into Cone Mapper CNN 
% Menu (function CnnFinder, line 2128).

fn = {'g1+cunefare', 'alex training set', '41 eye jlr set (black cut)', 'julius montages', 'julius montages2', '49 montages (2024)', 'NEW_SET_USER_FRIENDLY_NAME'};
            [indx, tf] = listdlg('Name', 'Cone Finder Data Sets', 'PromptString', {'Select a cone finder data set.'},...
                'SelectionMode','single','ListString', fn);
            
            % if user clicked 'Cancel'
            if ~tf
                DataSet = 'hamwoodset';
            else
                switch indx
                    case 1 % 'g1+cunefare'
                        DataSet = 'g1+cunefare';
                        
                    case 2 % 'alex training set'
                        DataSet = 'alex training set';
                       
                    case 3
                        DataSet = '41 eye jlr set (black cut)';
                        
                    case 4
                        DataSet = 'julius montages';
                    
                    case 5
                        DataSet = 'julius montages2';
                    
                    case 6
                        DataSet = 'hamwoodset';

                    case 7
                        DataSet = 'NEW_SET_NAME';
                end % switch
            end
%% 
% Don't forget that order in 'fn' cell array is corresponding to the numbers 
% in switch statement.
% See also
% For more information about Cunefare CNN, please check the github page: <https://github.com/DavidCunefare/CNN-Cone-Detection 
% https://github.com/DavidCunefare/CNN-Cone-Detection>
% 
% And check his article: Cunefare, D., Fang, L., Cooper, R.F. _et al._ Open 
% source software for automatic detection of cone photoreceptors in adaptive optics 
% ophthalmoscopy using convolutional neural networks. _Sci Rep_ *7*, 6620 (2017). 
% <https://doi.org/10.1038/s41598-017-07103-0 https://doi.org/10.1038/s41598-017-07103-0>
##### SOURCE END #####
-->
</div></body></html>